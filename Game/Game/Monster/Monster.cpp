#include "YonemaEnginePreCompile.h"
#include "../Status.h"
#include "Monster.h"
#include "MonsterList.h"
#include "../Item/MaterialItemList.h"

#include "../UI/Battle/Enemy/EnemyBattleStatusUI.h"

namespace nsAWA {

	namespace nsMonster {

		namespace {

			constexpr const char* const kMonsterModelTextureRootPath = "monster";	//モンスターモデルのテクスチャのパス
			constexpr int kDropMin = 1;	//ドロップ最低確率
			constexpr int kDropMax = 100;//ドロップ最大確率
			constexpr int kNormalItemDropPer = 80;//ノーマルアイテムのドロップ率(％)
			constexpr int kRareItemDropPer = 30;//レアアイテムのドロップ率(％)
		}

		const char* const CMonster::m_kObjName_Monster = "Monster";

		bool CMonster::StartSub() {

			return true;
		}

		void CMonster::OnDestroySub() {

			//アニメーションを破棄。
			m_animation.Release();

			//コライダーを破棄。
			m_collider.Release();

			//AIコントローラーを破棄。
			m_AIContoller.Release();

			// UIを破棄
			DeleteGO(m_enemyBattleStatusUI);
		}

		void CMonster::UpdateActor(float deltaTime) {

			if (m_isInited != true)
			{
				InitAfterLoadModel();
				return;
			}


			// UIの処理
			m_enemyBattleStatusUI->SetUIEnemyStatus(
				m_status.GetHP(), m_status.GetMaxHP(), 0.0f
			);
			m_enemyBattleStatusUI->SetUIEnemyPosition(m_position);

			//死んでいるなら。
			if (IsDeath()) {

				//死亡状態に。
				SetState(EnMonsterState::enDeath);

				//アニメーションを更新。
				m_animation.Update(m_isChangeState, m_state);

				//ステートの変更状況を初期化。
				m_isChangeState = false;

				//コライダーを破棄。
				if (!m_collider.IsReleased()) {

					m_collider.Release();
				}

				//これ以上は何もせず終了。
				return;
			}

			//AIコントローラーを更新。
			m_AIContoller.Update(deltaTime);

			//コライダーを更新。
			m_collider.Update();

			//アニメーションを更新。
			m_animation.Update(m_isChangeState, m_state);		

			//ステートの変更状況を初期化。
			m_isChangeState = false;
		}

		void CMonster::Create(const SMonsterInitData& monsterInfo) {

			m_initData = monsterInfo;

			//モンスターモデルを生成。
			CreateMonsterModel(m_initData);


		}

		void CMonster::ApplyDamage(float damage, float power, bool canGuard) {

			//ダメージをくらう。
			m_status.DamageHP(damage);

			//ひるみ値を加算。
			m_status.AddWinceValue(damage);

			//ひるみ値がひるみ値の区切りを超えていたら。
			if (m_status.GetWinceValue() >= m_status.GetWinceDelimiter()) {

				//ダメージ状態に設定。
				SetState(EnMonsterState::enDamage);

				//クールタイムをONに設定。
				m_AIContoller.CoolTimeOn();

				//一回ひるんだので、二回以上のひるみは無効とする。
				while (m_status.GetWinceValue() >= m_status.GetWinceDelimiter()) {

					//ひるみ値を減算。
					m_status.SubWinceValue(m_status.GetWinceDelimiter());
				}
			}

			//プレイヤーを発見。
			m_AIContoller.FindPlayer();
		}

		void CMonster::CreateMonsterModel(const SMonsterInitData& monsterInfo) {

			//モンスターモデルを生成。
			m_modelRenderer = NewGO<CModelRenderer>();

			//モンスターモデルの初期化データを定義。
			SModelInitData modelInitData;
			modelInitData.modelFilePath = monsterInfo.modelFilePath.c_str();
			modelInitData.textureRootPath = kMonsterModelTextureRootPath;
			modelInitData.SetFlags(EnModelInitDataFlags::enRegisterAnimationBank);
			modelInitData.SetFlags(EnModelInitDataFlags::enRegisterTextureBank);
			modelInitData.SetFlags(EnModelInitDataFlags::enLoadingAsynchronous);
			modelInitData.SetFlags(EnModelInitDataFlags::enShadowCaster);

			
			//アニメーションの数を取得。
			const int animNum = static_cast<int>(monsterInfo.animationFilePath.size());

			//アニメーションのファイルパスの配列を定義。
			std::vector<const char*> animNumVec;

			//アニメーションの数だけ回してファイルパスを格納。
			for (int animIndex = 0; animIndex < animNum; animIndex++) {
			
				//アニメーションのファイルパスを取得。
				animNumVec.emplace_back(monsterInfo.animationFilePath[animIndex].c_str());
			}
		

			//アニメーションのデータを設定。
			modelInitData.animInitData.Init(
				static_cast<unsigned int>(animNum),
				animNumVec.data()
			);
			
			//モンスターモデルを初期化。
			m_modelRenderer->Init(modelInitData);
			m_modelRenderer->SetScale(0.1f);
		}

		void CMonster::InitAfterLoadModel()
		{
			if (m_modelRenderer->IsLoadingAsynchronous())
			{
				return;
			}

			//名前を設定。
			m_name = m_initData.name;

			//獲得経験値量を設定。
			m_dropExp = m_initData.dropExp;

			//ドロップアイテムのリストを設定。
			m_dropItemList = m_initData.dropMaterialItemList;

			//ステータスを初期化。
			m_status.Init(m_name);

			//属性を設定。
			m_status.SetAttribute(m_initData.attribute);

			//アニメーションイベントを初期化。
			m_animation.InitAnimationEvent(this, &m_AIContoller);

			//アニメーションを初期化。
			m_animation.Init(
				m_modelRenderer,
				m_initData.animDataList,
				m_initData.animationFilePath
			);

			//AIコントローラーを初期化。
			m_AIContoller.Init(this);

			//当たり判定を初期化。
			m_collider.Init(this);

			//待機状態に設定。
			SetState(EnMonsterState::enIdle);

			// UIの処理
			m_enemyBattleStatusUI = NewGO<nsUI::CEnemyBattleStatusUI>();
			m_enemyBattleStatusUI->LoadLevel();

			m_isInited = true;

			return;
		}


		CStatus* CMonster::GetStatus() {

			//ステータスを取得。
			return &m_status;
		}

		bool CMonster::CheckDrop(const std::string& dropItemName) {

			//素材アイテムリストクラスのインスタンスを取得。
			auto materialItemListInstance = nsItem::CMaterialItemList::GetInstance();

			//素材アイテム情報を取得。
			nsItem::SMaterialItemInfo materialItem = materialItemListInstance->GetMaterialItemInfo(dropItemName);

			//抽選。
			int result = Random()->GetRangeInt(kDropMin, kDropMax);

			//結果をリターン。
			if (materialItem.rank == "Normal" && result <= kNormalItemDropPer
				|| materialItem.rank == "Rare" && result <= kRareItemDropPer
				){

				//成功。
				return true;
			}
			else {
				//失敗。
				return false;
			}
		}
	}
}
